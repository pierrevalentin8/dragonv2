<!DOCTYPE html>
<html lang="fr">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Popote & Dragons</title>
<style>
:root{
  --bg1:#1a1410;
  --bg2:#0f0c09;

  --paper:#fbf2df;
  --paper2:#fff8ea;
  --ink:#241b12;
  --muted:#6c5a44;

  --gold:#d4af37;
  --gold2:#b89020;
  --line:#e6d6ba;

  --panel: rgba(18,14,10,.72);
  --panel2: rgba(18,14,10,.58);

  --shadow: 0 18px 55px rgba(0,0,0,.45);
  --shadowSoft: 0 10px 30px rgba(0,0,0,.25);
  --r: 18px;
}

/* =========================
   Base / Mobile first
   ========================= */
*{ box-sizing:border-box; }
html, body{ height:100%; }

body{
  margin:0;
  font-family: 'IM Fell English SC', serif;
  color: var(--paper);
  background:
    radial-gradient(1200px 700px at 50% -10%, rgba(212,175,55,.14), transparent 60%),
    radial-gradient(900px 500px at 20% 110%, rgba(212,175,55,.10), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  display:flex;
  justify-content:center;
  align-items:center;
  padding: 18px 14px;
}

/* Texte lisible partout */
p, label, span, div{
  text-shadow: 0 1px 0 rgba(0,0,0,.35);
}

/* =========================
   Containers (Login / Village)
   ========================= */
.login-container,
.village-container{
  width: min(560px, 100%);
  background: linear-gradient(180deg, var(--panel), var(--panel2));
  border: 1px solid rgba(212,175,55,.35);
  border-radius: var(--r);
  box-shadow: var(--shadow);
  padding: 18px 16px;
  text-align:center;
  position: relative;
  overflow:hidden;
}

/* bordure â€œdorÃ©eâ€ interne */
.login-container::before,
.village-container::before{
  content:"";
  position:absolute;
  inset:10px;
  border-radius: calc(var(--r) - 8px);
  border: 1px solid rgba(212,175,55,.25);
  pointer-events:none;
}

/* petit glow fantasy */
.login-container::after,
.village-container::after{
  content:"";
  position:absolute;
  inset:-40px;
  background:
    radial-gradient(600px 180px at 50% 0%, rgba(212,175,55,.12), transparent 60%),
    radial-gradient(500px 220px at 10% 100%, rgba(212,175,55,.08), transparent 60%),
    radial-gradient(500px 220px at 90% 100%, rgba(212,175,55,.08), transparent 60%);
  pointer-events:none;
  opacity:.85;
}

h1,h2,h3{
  margin: 6px 0 10px;
  color: var(--gold);
  letter-spacing:.5px;
  text-shadow: 0 2px 0 rgba(0,0,0,.55);
}

h1{ font-size: 34px; }
h2{ font-size: 26px; }
h3{ font-size: 18px; color: #e7d8b6; }

.login-footer{
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid rgba(212,175,55,.35);
  color: rgba(245,240,220,.85);
  font-size: 14px;
}

/* =========================
   Buttons (global)
   ========================= */
button{
  font-family: 'IM Fell English SC', serif;
  width: 100%;
  border-radius: 14px;
  border: 1px solid rgba(212,175,55,.40);
  background:
    linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.12));
  color: var(--paper);
  padding: 12px 14px;
  margin: 6px 0;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 10px 22px rgba(0,0,0,.25);
  transition: transform .06s ease, filter .15s ease, border-color .15s ease;
}

button:hover{ filter: brightness(1.05); border-color: rgba(212,175,55,.7); }
button:active{ transform: translateY(1px); }

/* bouton â€œprimaire dorÃ©â€ */
.btn-primary{
  background: linear-gradient(180deg, var(--gold), var(--gold2));
  color: #1b1307;
  font-weight: 700;
  border-color: rgba(0,0,0,.10);
}

/* =========================
   Village layout (mobile-first)
   ========================= */
.village-header{
  text-align:center;
  margin-bottom: 6px;
}

#villageImage{
  width: 100%;
  max-width: 520px;
  border-radius: 16px;
  border: 1px solid rgba(212,175,55,.35);
  box-shadow: var(--shadowSoft);
}

.village-header h1{
  margin-top: 12px;
  font-size: 30px;
}

/* mobile: en colonne */
.village-main{
  display:flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
}

.player-panel{
  background: rgba(0,0,0,.28);
  border: 1px solid rgba(212,175,55,.28);
  border-radius: 16px;
  padding: 14px 14px;
  color: rgba(245,240,220,.95);
  box-shadow: 0 10px 24px rgba(0,0,0,.20);
}

.actions-panel{
  display:flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
}

.actions-panel button{
  width: 100%;
}

/* =========================
   Bank (mobile friendly)
   ========================= */
.bank-dashboard{
  width: 100%;
  border-radius: 16px;
  padding: 14px 14px;
  margin: 10px 0 0;
  background:
    linear-gradient(180deg, rgba(251,242,223,.96), rgba(245,235,210,.93)),
    repeating-linear-gradient(
      135deg,
      rgba(0,0,0,.015) 0px,
      rgba(0,0,0,.015) 2px,
      transparent 2px,
      transparent 9px
    );
  border: 1px solid rgba(212,175,55,.35);
  box-shadow: var(--shadowSoft);
  color: var(--ink);
  font-family: 'IM Fell English SC', serif;
}

.bank-dashboard h3{
  margin: 0 0 10px;
  text-align:center;
  color: #7a4a28;
  text-shadow: none;
  font-size: 20px;
}

.bank-row{
  display:flex;
  justify-content: space-between;
  align-items:center;
  padding: 10px 12px;
  margin-bottom: 8px;
  border-radius: 14px;
  font-weight: 700;
  border: 1px solid rgba(0,0,0,.06);
}

.gold-row{ background: #fff5cf; color:#9a6a00; }
.house-row{ background: #e9f4ff; color:#1e67c6; }
.village-row{ background: #f6e9ff; color:#7a2aa8; }

.bank-label{ font-size: 15px; }
.bank-value{ font-size: 16px; }

/* =========================
   Overlay + Popups (D&D parchment)
   + Animation ouverture
   ========================= */
.overlay{
  display:none;
  position:fixed;
  inset:0;
  background: rgba(5,4,3,.55);
  backdrop-filter: blur(2px);
  z-index:500;
  animation: overlayIn .16s ease;
}

/* animation overlay (se joue quand display passe Ã  block) */
@keyframes overlayIn{
  from{ opacity:0; }
  to{ opacity:1; }
}

/* POPUP parchemin unifiÃ© */
.popup{
  display:none;
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%) scale(.98);
  z-index: 1000;

  width: min(92vw, 720px);
  max-height: 86vh;
  overflow:auto;

  /* Texture parchemin (100% CSS) */
  background:
    radial-gradient(1100px 600px at 50% -20%, rgba(212,175,55,.14), transparent 60%),
    radial-gradient(800px 420px at 10% 120%, rgba(161,113,49,.10), transparent 60%),
    radial-gradient(800px 420px at 90% 120%, rgba(161,113,49,.10), transparent 60%),
    repeating-linear-gradient(
      0deg,
      rgba(0,0,0,.018) 0px,
      rgba(0,0,0,.018) 1px,
      transparent 1px,
      transparent 6px
    ),
    repeating-linear-gradient(
      90deg,
      rgba(0,0,0,.012) 0px,
      rgba(0,0,0,.012) 1px,
      transparent 1px,
      transparent 10px
    ),
    linear-gradient(180deg, var(--paper2), var(--paper));

  color: var(--ink);
  border: 1px solid var(--line);
  border-radius: 18px;
  box-shadow: var(--shadow);
  padding: 16px 16px;

  /* Animation ouverture */
  opacity: 0;
  animation: popupIn .18s ease forwards;
}

/* Animation popup (quand display passe Ã  block) */
@keyframes popupIn{
  from{
    opacity: 0;
    transform: translate(-50%,-48%) scale(.96);
    filter: blur(.2px);
  }
  to{
    opacity: 1;
    transform: translate(-50%,-50%) scale(1);
    filter: blur(0);
  }
}

/* cadre interne dorÃ© */
.popup::before{
  content:"";
  position:absolute;
  inset: 10px;
  border-radius: 14px;
  border: 1px solid rgba(212,175,55,.35);
  pointer-events:none;
}

/* â€œgrainâ€ parchemin trÃ¨s lÃ©ger */
.popup::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 20% 30%, rgba(0,0,0,.045), transparent 35%),
    radial-gradient(circle at 80% 70%, rgba(0,0,0,.035), transparent 38%),
    radial-gradient(circle at 50% 90%, rgba(0,0,0,.03), transparent 40%);
  mix-blend-mode: multiply;
  opacity:.35;
  pointer-events:none;
}

.popup h2{
  margin: 2px 0 10px;
  font-size: 26px;
  color: #7a4a28;
  text-shadow: none;
}
.popup h3{ margin: 6px 0 10px; color: var(--muted); text-shadow:none; }

.popup p, .popup label{ color: var(--muted); text-shadow:none; }

.popup input, .popup select{
  width: 100%;
  display:block;
  margin: 10px 0;
  padding: 11px 12px;
  border-radius: 14px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.75);
  color: var(--ink);
  font-size: 16px;
  outline:none;
}

.popup input:focus, .popup select:focus{
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(212,175,55,.22);
}

.popup button{
  width: 100%;
  margin: 8px 0 0;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.88);
  color: var(--ink);
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
}

.popup button:hover{
  border-color: rgba(212,175,55,.75);
  background: rgba(212,175,55,.12);
}

.popup .btn-primary{
  background: linear-gradient(180deg, var(--gold), var(--gold2));
  color: #1a1206;
  font-weight: 800;
}

/* =========================
   Character sheet
   ========================= */
#characterSheetPopup{
  width: min(92vw, 520px);
}

#pcText{
  font-weight: 800;
  font-size: 16px;
  color: var(--ink);
  background: rgba(212,175,55,.18);
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(212,175,55,.25);
  text-shadow:none;
}

.stat-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  background: rgba(255,255,255,.74);
  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.06);
  margin: 8px 0;
  color: var(--ink);
  font-weight: 800;
  text-shadow:none;
}

.stat-row span{
  min-width: 40px;
  text-align:center;
}

.stat-row button{
  width: 44px;
  height: 40px;
  padding: 0;
  margin: 0;
  border-radius: 12px;
  background: linear-gradient(180deg, var(--gold), var(--gold2));
  color: #1b1307;
  font-weight: 900;
  border: 1px solid rgba(0,0,0,.08);
}

/* =========================
   Explore / Bestiary / Upgrade (unifiÃ©s)
   ========================= */
#explorePopup, #bestiaryPopup, #upgradeHousePopup{
  width: min(92vw, 720px);
}

#bestiaryContent{
  max-height: 55vh;
  overflow:auto;
}

/* =========================
   Admin tables responsive
   ========================= */
#adminPlayersList{ overflow-x:auto; }

.popup table{
  width: 100%;
  border-collapse: collapse;
  border-radius: 14px;
  overflow:hidden;
  border: 1px solid var(--line);
}

.popup thead th{
  background: linear-gradient(180deg, rgba(212,175,55,.35), rgba(212,175,55,.18));
  color: var(--ink);
  text-align:left;
  padding: 10px;
  position: sticky;
  top: 0;
  z-index: 1;
}

.popup td{
  padding: 10px;
  border-bottom: 1px solid var(--line);
}

.popup tbody tr:nth-child(2n){
  background: rgba(255,255,255,.35);
}

#adminPlayersList select,
#adminPlayersList input{
  width: 100%;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.78);
  color: var(--ink);
  font-family: 'IM Fell English SC', serif;
}

/* =========================
   Combat UI (tes classes existantes)
   ========================= */
.combat-wrap{ display:flex; flex-direction:column; gap:12px; }
.combat-top{
  display:grid;
  grid-template-columns: 1fr 70px 1fr;
  align-items:center;
  gap:10px;
}
.combat-vs{
  text-align:center;
  font-size:18px;
  opacity:.85;
  text-shadow:none;
  color: var(--muted);
}
.combat-card{
  background: rgba(255,255,255,.62);
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,.10);
  color: var(--ink);
  text-shadow:none;
}
.combat-name{ font-size: 20px; margin: 0 0 6px; }
.combat-emoji{ font-size: 54px; line-height: 1; margin-bottom: 8px; }
.combat-stats{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  color: var(--muted);
  font-size: 14px;
  text-shadow:none;
}
.badge{
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.58);
}
.hpbar{
  margin-top: 10px;
  height: 12px;
  border-radius: 999px;
  background: rgba(0,0,0,.08);
  overflow:hidden;
  border: 1px solid rgba(0,0,0,.08);
}
.hpfill{
  height:100%;
  width:100%;
  background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(212,175,55,.95));
  transition: width .35s ease;
}
.combat-log{
  background: rgba(255,255,255,.72);
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 10px 12px;
  color: var(--ink);
  font-size: 15px;
  text-shadow:none;
}

/* petites animations */
@keyframes popIn { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.combat-animate{ animation: popIn .18s ease; }
@keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-4px)} 50%{transform:translateX(4px)} 75%{transform:translateX(-3px)} 100%{transform:translateX(0)} }
.shake{ animation: shake .22s ease; }

/* =========================
   Desktop enhancements
   ========================= */
@media (min-width: 900px){
  body{ padding: 26px; }
  .village-container{ width: min(980px, 100%); }
  .village-main{ flex-direction: row; align-items:flex-start; }
  .player-panel{ flex: 2; }
  .actions-panel{ flex: 1; }
}
/* =========================
   Boutons en 2 colonnes
   (Fiche perso + Explorer)
   ========================= */

/* Fiche perso : Valider / Annuler cÃ´te Ã  cÃ´te */
#characterSheetPopup #saveStatsBtn,
#characterSheetPopup #cancelStatsBtn{
  width: auto;            /* annule le 100% global */
  margin: 0;              /* on gÃ¨re via gap */
}

#characterSheetPopup{
  /* petit confort */
  padding-bottom: 18px;
}

#characterSheetPopup #saveStatsBtn,
#characterSheetPopup #cancelStatsBtn{
  flex: 1;
}

/* on enveloppe les 2 boutons via un layout â€œautoâ€ (sans modifier ton HTML) */
#characterSheetPopup #saveStatsBtn{
  float: left;
  width: calc(50% - 6px);
}
#characterSheetPopup #cancelStatsBtn{
  float: right;
  width: calc(50% - 6px);
}

/* clear float pour Ã©viter les soucis de layout */
#characterSheetPopup #cancelStatsBtn::after{
  content:"";
  display:block;
  clear:both;
}

/* Explorer : Combat suivant / Fermer cÃ´te Ã  cÃ´te */
#explorePopup #exploreNext,
#explorePopup #exploreClose{
  width: auto;
  margin: 0;
  flex: 1;
}

/* ton HTML a dÃ©jÃ  un wrapper en flex avec gap => on force juste le bon sizing */
#explorePopup button{
  max-width: none;
}

/* Sur trÃ¨s petit Ã©cran, on repasse en colonne */
@media (max-width: 360px){
  #characterSheetPopup #saveStatsBtn,
  #characterSheetPopup #cancelStatsBtn{
    float:none;
    width: 100%;
    margin-top: 8px;
  }
}


</style>
</head>
<body>
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>


<!-- PAGES -->
<div class="login-container" id="loginPage">
    <h1>Popote & Dragons</h1>
    <button id="createBtn">CrÃ©er un compte</button>
    <button id="loginBtn">Connexion</button>

    <div class="login-footer">
        2026 - ImaginÃ© et crÃ©Ã© par PM avec l'aide de Chat GPT - MAJ 025
    </div>
</div>


<!-- ===== MAISON ET BANQUE ===== -->
<div class="village-container" id="villagePage" style="display:none;">
    <!-- IMAGE HEADER -->
    <div class="village-header">
        <img src="Maison 1.png" alt="Maison Fantasy" id="villageImage">
        <h1>Maison</h1>
    </div>

    <div class="village-main">
        <!-- INFOS JOUEUR -->
        <div class="player-panel">
            <h2 id="welcomeText">Bienvenue, aventurier.</h2>
            <p id="teamText"></p>
            <p id="levelText"></p>
            <p id="xpText"></p>
        </div>

        <!-- BOUTONS ACTIONS -->
        <div class="actions-panel">
            <button id="upgradeHouseBtn">ğŸ  AmÃ©liorer l'habitation</button>
            <button id="openCharacterSheetBtn">ğŸ“ Fiche</button>
            <button id="exploreBtn">ğŸŒ³ Explorer</button>
            <button id="bestiaryBtn">ğŸ“– Bestiaire</button>
            <button id="inventoryBtn">ğŸ’ Inventaire</button>
            <button id="logoutBtn">ğŸšª DÃ©connexion</button>
            <button id="adminBtn" style="display:none;">âš”ï¸ Admin</button>
        </div>

        <!-- POPUP AMÃ‰LIORATION MAISON -->
        <div class="popup" id="upgradeHousePopup">
            <h2>AmÃ©liorer votre maison</h2>
            <p id="currentHouse"></p>
            <p id="nextHouse"></p>

            <div id="houseProgress" style="width:100%; background:#ddd; border-radius:8px; height:12px; margin:10px auto;">
              <div id="houseProgressFill" style="width:0%; background:#d4af37; height:100%; border-radius:8px;"></div>
            </div>

            <button id="confirmUpgradeBtn">AmÃ©liorer</button>
            <button id="cancelUpgradeBtn">Annuler</button>
        </div>
    </div>
 <!-- BANQUE -->
    <div class="bank-dashboard">
        <h3>ğŸ¦ Banque</h3>
        <div class="bank-row gold-row">
            <span class="bank-label">Sous actuels</span>
            <span class="bank-value" id="bankGold">0</span>
        </div>
        <div class="bank-row house-row">
            <span class="bank-label">ğŸ  DÃ©penses Maison</span>
            <span class="bank-value" id="bankHouse">0</span>
        </div>
        <div class="bank-row village-row">
            <span class="bank-label">ğŸ˜ï¸ DÃ©penses Village</span>
            <span class="bank-value" id="bankVillage">0</span>
        </div>
    </div>
</div>

<!-- OVERLAY UNIQUE -->
<div class="overlay" id="overlay" style="display:none;"></div>




<!-- POPUPS -->
<div class="popup" id="adminPopup">
    <div class="popup-header">
  <div class="popup-title">
    <div class="popup-icon">âš”ï¸</div>
    <div>
      <h2 style="margin:0;">Panel Admin</h2>
      <div class="popup-subtitle">Gestion des joueurs & des crÃ©atures</div>
    </div>
  </div>
</div>
<div class="gold-rule"></div>
<div class="toolbar" style="justify-content:flex-start;">
  <button id="tabPlayersBtn" class="btn-primary">ğŸ‘¤ Joueurs</button>
  <button id="tabMonstersBtn">ğŸ§Ÿ CrÃ©atures</button>
</div>

<div id="tabPlayersPanel">
  <div id="adminPlayersList" style="margin-top:10px;"></div>
</div>

<div id="tabMonstersPanel" style="display:none; margin-top:10px;">
  <p style="margin:0 0 10px; color:var(--muted);">
    AccÃ¨s rapide Ã  la gestion des crÃ©atures.
  </p>
  <div class="toolbar">
    <button id="openMonstersAdminBtn" class="btn-primary">ğŸ§Ÿ Ouvrir la liste</button>
    <button id="openAddMonsterBtn">â• CrÃ©er une crÃ©ature</button>
    
  </div>
  
</div>
<button id="tabSettingsBtn">âš™ï¸ ParamÃ¨tres</button>
<div id="tabSettingsPanel" style="display:none; margin-top:10px;">
  <h3>Limite de combats par jour</h3>
  <p style="margin-top:0; color:var(--muted);">
    0 = illimitÃ©. La limite sâ€™applique Ã  tous les joueurs.
  </p>

  <div class="toolbar">
    <input id="dailyCombatLimitInput" type="number" min="0" step="1" placeholder="Ex: 20">
    <button id="saveDailyCombatLimitBtn" class="btn-primary">ğŸ’¾ Enregistrer</button>
  </div>

  <p id="dailyCombatLimitInfo" style="color:var(--muted); margin-top:8px;"></p>
</div>


    <button id="adminClose">Fermer</button>
</div>
<!-- ===== POPUP AJOUT CREATURE ===== -->
<div class="popup" id="addMonsterPopup" style="display:none;">
    <h2>Ajouter une crÃ©ature</h2>

    <form id="addMonsterForm">

        <input type="text" id="addMonsterName" placeholder="Nom de la crÃ©ature">
        <input type="number" id="addMonsterAttack" placeholder="Attaque">
        <input type="number" id="addMonsterDefense" placeholder="DÃ©fense">
        <input type="number" id="addMonsterHp" placeholder="Points de vie">
        <input type="number" id="addMonsterGold" placeholder="RÃ©compense en sous">

        <p>Image de la crÃ©ature :</p>
        <input type="file" id="addMonsterImage" accept="image/*">

        <button type="button" id="addMonsterSaveBtn" class="btn-primary">
    Enregistrer
</button>


        <button type="button" id="addMonsterCancelBtn">
            Annuler
        </button>

    </form>
</div>



<div class="popup" id="createPopup">
    <h2>CrÃ©er un compte</h2>
    <input type="email" id="createEmail" placeholder="Adresse email">
    <input type="password" id="createPassword" placeholder="Mot de passe">
    <button id="createSubmit">Valider</button>
    <button id="createBack">Retour</button>
</div>

<div class="popup" id="loginPopup">
    <h2>Connexion</h2>
    <input type="email" id="loginEmail" placeholder="Adresse email">
    <input type="password" id="loginPassword" placeholder="Mot de passe">
    <button id="loginSubmit">Se connecter</button>
    <button id="loginBack">Retour</button>
</div>

<div class="popup" id="characterPopup">
    <h2>Viens prendre part Ã  cette aventure</h2>
    <input type="text" id="characterName" placeholder="Nom du personnage">
    <select id="characterClass">
        <option value="">-- Classe --</option>
        <option>Guerrier</option>
        <option>Voleur</option>
        <option>Mage</option>
        <option>NÃ©cromancien</option>
        <option>Archer</option>
        
    </select>
    <p>Points de compÃ©tence restants : <span id="pointsRestants">10</span></p>
    <label>Attaque</label><input type="number" id="statAttaque" min="0" value="0">
    <label>DÃ©fense</label><input type="number" id="statDefense" min="0" value="0">
    <label>Esquive</label><input type="number" id="statEsquive" min="0" value="0">
    <label>Points de vie</label><input type="number" id="statVie" min="0" value="0">
    <button id="characterSubmit">Entrer dans le monde</button>
</div>

<div class="popup" id="monstersAdminPopup" style="display:none; max-width:900px;">
  <h2>ğŸ§Ÿ Gestion des crÃ©atures</h2>

  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
    <button id="monstersCreateBtn">â• CrÃ©er une crÃ©ature</button>
    <input id="monsterSearchInput" type="text" placeholder="ğŸ” Rechercher..." style="flex:1; min-width:220px;">
    <select id="monsterSortSelect">
      <option value="name_asc">Nom Aâ†’Z</option>
      <option value="name_desc">Nom Zâ†’A</option>
      <option value="hp_desc">HP â†“</option>
      <option value="gold_desc">Or â†“</option>
      <option value="attack_desc">ATK â†“</option>
      <option value="defense_desc">DEF â†“</option>
    </select>
    <button id="monstersBackToAdminBtn">â¬… Retour Admin</button>
  </div>

  <div id="monstersList" style="max-height:420px; overflow:auto; text-align:left;"></div>

  <div style="display:flex; justify-content:space-between; margin-top:10px;">
    <button id="monstersPrevBtn">â¬… Page prÃ©cÃ©dente</button>
    <button id="monstersNextBtn">Page suivante â¡</button>
  </div>
</div>


<div class="popup" id="characterSheetPopup">
    <h2>ğŸ›¡ï¸ Fiche Personnage ğŸ—¡ï¸</h2>

    <!-- INFOS GÃ‰NÃ‰RALES -->
    <p id="sheetClass"></p>
    <p id="sheetTeam"></p>
    <p id="sheetLevel"></p>

    <p id="pcText" data-pc="0">Points de CompÃ©tence restants : 0</p>

    <!-- STATS + / - -->
    <div class="stat-row">
        <span>Attaque: </span>
        <button class="dec" data-stat="attaque">-</button>
        <span id="sheetAttaque">0</span>
        <button class="inc" data-stat="attaque">+</button>
    </div>
    <div class="stat-row">
        <span>DÃ©fense: </span>
        <button class="dec" data-stat="defense">-</button>
        <span id="sheetDefense">0</span>
        <button class="inc" data-stat="defense">+</button>
    </div>
    <div class="stat-row">
        <span>Esquive: </span>
        <button class="dec" data-stat="esquive">-</button>
        <span id="sheetEsquive">0</span>
        <button class="inc" data-stat="esquive">+</button>
    </div>
    <div class="stat-row">
        <span>Vie: </span>
        <button class="dec" data-stat="vie">-</button>
        <span id="sheetVie">0</span>
        <button class="inc" data-stat="vie">+</button>
    </div>

    <button id="saveStatsBtn">Valider</button>
    <button id="cancelStatsBtn">Annuler</button>
</div>


<div class="overlay" id="overlay"></div>

<div class="popup" id="explorePopup">
    <h2 id="exploreTitle">ğŸŒ³ Exploration</h2>
    <div id="exploreContent" style="text-align:center; font-size:1.1em; margin:10px 0;"></div>
    <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
        <button id="exploreNext">âš”ï¸ Combat suivant</button>
        <button id="exploreClose">âŒ Fermer</button>
    </div>
</div>
<div class="popup" id="bestiaryPopup">
    <div id="bestiaryContent" style="max-height:400px; overflow-y:auto; text-align:left;"></div>
    <button id="closeBestiary">Fermer</button>
</div>


<script>
// ===== CONFIG FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyDxSVEnK9stHRQxF-WEUAaVQ5OjM1jqmXU",
  authDomain: "popoteetdragonv2.firebaseapp.com",
  projectId: "popoteetdragonv2",
  storageBucket: "popoteetdragonv2.firebasestorage.app",
  messagingSenderId: "1012170229310",
  appId: "1:1012170229310:web:4914b80585158c0c42736f"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// Fonction utilitaire pour assigner un onclick en toute sÃ©curitÃ©
function safeOnClick(id, callback){
    const el = document.getElementById(id);
    if(el) el.onclick = callback;
}

let bank = { gold:0, houseSpent:0, villageSpent:0 };

// Fonction pour mettre Ã  jour la banque
function updateBankDisplay(playerData){
    const ch = playerData?.character;

    if(ch){
        if(typeof ch.gold === "number") bank.gold = ch.gold;
        if(typeof ch.spentHouse === "number") bank.houseSpent = ch.spentHouse;
        if(typeof ch.spentVillage === "number") bank.villageSpent = ch.spentVillage;
    }

    const goldEl = document.getElementById('bankGold');
    const houseEl = document.getElementById('bankHouse');
    const villageEl = document.getElementById('bankVillage');

    if(goldEl) goldEl.textContent = bank.gold;
    if(houseEl) houseEl.textContent = bank.houseSpent;
    if(villageEl) villageEl.textContent = bank.villageSpent;
}



// ===== AMÃ‰LIORER MAISON =====
const upgradeHouseBtn = document.getElementById('upgradeHouseBtn');
const upgradeHousePopup = document.getElementById('upgradeHousePopup');
const confirmUpgradeBtn = document.getElementById('confirmUpgradeBtn');
const cancelUpgradeBtn = document.getElementById('cancelUpgradeBtn');
const currentHouseP = document.getElementById('currentHouse');
const nextHouseP = document.getElementById('nextHouse');

const houses = [
    {name:"Tente", defense:3, cost:0},
    {name:"Cabane", defense:6, cost:10},
    {name:"ChaumiÃ¨re", defense:9, cost:20},
    {name:"Maison", defense:12, cost:40},
    {name:"Grande Maison", defense:15, cost:80},
    {name:"Manoir", defense:18, cost:160},
    {name:"Villa", defense:21, cost:320},
    {name:"Domaine", defense:24, cost:640},
    {name:"Palais", defense:27, cost:1280},
    {name:"ChÃ¢teau", defense:30, cost:2560},
];

// Ouvrir popup
if(upgradeHouseBtn) upgradeHouseBtn.onclick = async () => {
    const doc = await db.collection('players').doc(currentUser).get();
    const player = doc.data();
    if(!player.houseLevel) player.houseLevel = 0;
    const currentLevel = player.houseLevel;
    const nextLevel = currentLevel < houses.length - 1 ? currentLevel + 1 : currentLevel;

    currentHouseP.textContent = `ğŸ  Maison actuelle : ${houses[currentLevel].name} (DÃ©fense: ${houses[currentLevel].defense})`;
    if(currentLevel === nextLevel){
        nextHouseP.textContent = "Vous avez dÃ©jÃ  le maximum !";
        confirmUpgradeBtn.style.display = 'none';
    } else {
        nextHouseP.textContent = `ğŸ›¡ Prochaine amÃ©lioration : ${houses[nextLevel].name} (DÃ©fense: ${houses[nextLevel].defense}, CoÃ»t: ${houses[nextLevel].cost} sous)`;
        confirmUpgradeBtn.style.display = 'inline-block';
    }
    overlay.style.display = 'block';
    upgradeHousePopup.style.display = 'block';
};

// Fermer popup
if(cancelUpgradeBtn) cancelUpgradeBtn.onclick = () => {
    overlay.style.display = 'none';
    upgradeHousePopup.style.display = 'none';
};

// Confirmer amÃ©lioration
if(confirmUpgradeBtn) confirmUpgradeBtn.onclick = async () => {
    const doc = await db.collection('players').doc(currentUser).get();
    const player = doc.data();
    if(!player.houseLevel) player.houseLevel = 0;
    const currentLevel = player.houseLevel;
    const nextLevel = currentLevel + 1;

    if(nextLevel >= houses.length){
        alert("Vous avez dÃ©jÃ  le niveau maximum !");
        return;
    }

    const cost = houses[nextLevel].cost;
    if(!player.character.gold) player.character.gold = 0;
    if(!player.character.spentHouse) player.character.spentHouse = 0;

    if(player.character.gold < cost){
        alert(`Pas assez d'argent ! Il vous faut ${cost} sous.`);
        return;
    }

    const newGold = player.character.gold - cost;
    const newSpentHouse = player.character.spentHouse + cost;

    await db.collection('players').doc(currentUser).update({
        houseLevel: nextLevel,
        "character.gold": newGold,
        "character.spentHouse": newSpentHouse
    });

    alert(`ğŸ  Maison amÃ©liorÃ©e : ${houses[nextLevel].name} !`);
    overlay.style.display = 'none';
    upgradeHousePopup.style.display = 'none';

    // Mise Ã  jour banque
    updateBankDisplay(await db.collection('players').doc(currentUser).get().then(d=>d.data()));
};
// ===== GARDER L'UTILISATEUR CONNECTÃ‰ APRÃˆS REFRESH =====
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // Utilisateur connectÃ©
        currentUser = user.uid;
        await loadGameConfig(); // âœ… charge la limite combats/jour dÃ¨s la connexion (mÃªme aprÃ¨s refresh)
        await ensureDailyCombatCounter(); // âœ… initialise / reset uniquement si nouveau jour


        // RÃ©cupÃ¨re les donnÃ©es du joueur
        let data = { character:null, level:1, xp:0 };

try {
    // stop ancien listener si refresh / changement de compte
if (unsubscribePlayerListener) unsubscribePlayerListener();

// listener temps rÃ©el du joueur (banque + UI toujours Ã  jour)
unsubscribePlayerListener = db.collection('players').doc(currentUser).onSnapshot((doc) => {
    const data = doc.exists ? doc.data() : { character:null, level:1, xp:0 };

    // --- Banque ---
    updateBankDisplay(data);

    // --- UI principale ---
    if(data.character){
    // âœ… IMPORTANT : fermer toutes les popups de crÃ©ation au refresh
    overlay.style.display = 'none';
    characterPopup.style.display = 'none';

    villagePage.style.display = 'block';
    loginPage.style.display = 'none';

    welcomeText.textContent = `Bienvenue ${data.character.name}, ${data.character.classe}.`;
    teamText.textContent = `Ã‰quipe : ${data.character.team}`;
    levelText.textContent = `Niveau : ${data.level || 1}`;
    xpText.textContent = `XP : ${data.xp || 0} / ${10*(data.level || 1)}`;
} else {
    overlay.style.display = 'block';
    characterPopup.style.display = 'block';
}

}, (err) => {
    console.error("Firestore: listener joueur erreur", err);
});

} catch (e) {
  console.error("Firestore read failed", e);
  alert("Erreur Firestore (permissions). VÃ©rifie tes rÃ¨gles Firestore puis recharge.");
  return;
}




// --- Chargement de la banque ---
        // Affichage selon si personnage existant ou non
        if(data.character){
            villagePage.style.display = 'block';
            loginPage.style.display = 'none';
            welcomeText.textContent = `Bienvenue ${data.character.name}, ${data.character.classe}.`;
            teamText.textContent = `Ã‰quipe : ${data.character.team}`;
            levelText.textContent = `Niveau : ${data.level || 1}`;
            xpText.textContent = `XP : ${data.xp || 0} / ${10*(data.level || 1)}`;
        } else {
            overlay.style.display='block';
            characterPopup.style.display='block';
            updateBankDisplay();

        }
// Initialisation des boutons du bestiaire
document.getElementById('bestiaryBtn').onclick = openBestiary;
document.getElementById('closeBestiary').onclick = () => {
    overlay.style.display = 'none';
    document.getElementById('bestiaryPopup').style.display = 'none';
};

        // Affiche bouton admin si nÃ©cessaire
        adminBtn.style.display = user.email === adminEmail ? 'inline-block' : 'none';

    } else {
        // Pas d'utilisateur connectÃ©
        currentUser = null;
        villagePage.style.display = 'none';
        loginPage.style.display = 'block';
        adminBtn.style.display = 'none';
        teamText.textContent = '';
        let monstersCache = [];
let monstersPageIndex = 0;
const monstersPageSize = 50;

    }
});
function openMonstersAdminPopup() {
  overlay.style.display = 'block';
  adminPopup.style.display = 'none';
  document.getElementById('monstersAdminPopup').style.display = 'block';
  monstersPageIndex = 0;
  loadMonstersList();
}

function backToAdminPopup() {
  document.getElementById('monstersAdminPopup').style.display = 'none';
  adminPopup.style.display = 'block';
}

async function loadMonstersList() {
  const u = firebase.auth().currentUser;
  if (!u || u.email !== adminEmail) {
    alert("AccÃ¨s admin refusÃ©.");
    return;
  }

  const snap = await db.collection("monsters").get();
  monstersCache = [];
  snap.forEach(d => monstersCache.push({ id: d.id, ...d.data() }));

  renderMonstersList();
}

function renderMonstersList() {
  const list = document.getElementById('monstersList');
  if (!list) return;

  const q = (document.getElementById('monsterSearchInput').value || "").toLowerCase().trim();
  const sort = document.getElementById('monsterSortSelect').value;

  let rows = monstersCache.slice();

  // filtre
  if (q) rows = rows.filter(m => (m.name || "").toLowerCase().includes(q));

  // tri
  const num = v => (typeof v === "number" ? v : parseInt(v, 10) || 0);
  rows.sort((a, b) => {
    if (sort === "name_asc") return (a.name||"").localeCompare(b.name||"");
    if (sort === "name_desc") return (b.name||"").localeCompare(a.name||"");
    if (sort === "hp_desc") return num(b.hp) - num(a.hp);
    if (sort === "gold_desc") return num(b.gold) - num(a.gold);
    if (sort === "attack_desc") return num(b.attack) - num(a.attack);
    if (sort === "defense_desc") return num(b.defense) - num(a.defense);
    return 0;
  });

  // pagination locale
  const start = monstersPageIndex * monstersPageSize;
  const page = rows.slice(start, start + monstersPageSize);

  list.innerHTML = "";

  if (page.length === 0) {
    list.innerHTML = "<p>Aucune crÃ©ature.</p>";
    document.getElementById('monstersPrevBtn').disabled = true;
    document.getElementById('monstersNextBtn').disabled = true;
    return;
  }

  page.forEach(m => {
    const line = document.createElement("div");
    line.style.display = "flex";
    line.style.alignItems = "center";
    line.style.justifyContent = "space-between";
    line.style.gap = "10px";
    line.style.padding = "8px";
    line.style.borderBottom = "1px solid #ddd";

    const left = document.createElement("div");
    left.style.flex = "1";
    left.style.cursor = "pointer";
    left.innerHTML = `<b>${m.name || "(sans nom)"}</b>
      <span style="opacity:.8;"> â€” ATK:${m.attack ?? 0} DEF:${m.defense ?? 0} HP:${m.hp ?? 0} Or:${m.gold ?? 0}</span>`;
    left.onclick = () => openEditMonster(m); // utilise ta popup existante

    const right = document.createElement("div");

    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸";
    editBtn.title = "Modifier";
    editBtn.onclick = () => openEditMonster(m);

    const delBtn = document.createElement("button");
    delBtn.textContent = "ğŸ—‘ï¸";
    delBtn.title = "Supprimer";
    delBtn.onclick = async () => {
      if (!confirm(`Supprimer "${m.name}" ?`)) return;
      await db.collection("monsters").doc(m.id).delete();
      monstersCache = monstersCache.filter(x => x.id !== m.id);
      renderMonstersList();
    };

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    line.appendChild(left);
    line.appendChild(right);
    list.appendChild(line);
  });

  document.getElementById('monstersPrevBtn').disabled = monstersPageIndex <= 0;
  document.getElementById('monstersNextBtn').disabled = (start + monstersPageSize) >= rows.length;
}
safeOnClick('openMonstersAdminBtn', openMonstersAdminPopup);
safeOnClick('monstersBackToAdminBtn', backToAdminPopup);

safeOnClick('monstersCreateBtn', () => { backToAdminPopup(); openAddMonsterPopup(); });

safeOnClick('monstersPrevBtn', () => { monstersPageIndex = Math.max(0, monstersPageIndex - 1); renderMonstersList(); });
safeOnClick('monstersNextBtn', () => { monstersPageIndex += 1; renderMonstersList(); });

document.getElementById('monsterSearchInput').oninput = () => { monstersPageIndex = 0; renderMonstersList(); };
document.getElementById('monsterSortSelect').onchange = () => { monstersPageIndex = 0; renderMonstersList(); };

// ===== VARIABLES =====
let currentUser = null;
let teamToggle = 0;
const creationPointsRestants = 10;
const adminEmail = "pierre.valentin8@gmail.com";
let unsubscribePlayerListener = null;


// Ã‰lÃ©ments DOM
const overlay = document.getElementById('overlay');
const loginPage = document.getElementById('loginPage');
const villagePage = document.getElementById('villagePage');
const createPopup = document.getElementById('createPopup');
const loginPopup = document.getElementById('loginPopup');
const characterPopup = document.getElementById('characterPopup');

const statAttaque = document.getElementById('statAttaque');
const statDefense = document.getElementById('statDefense');
const statEsquive = document.getElementById('statEsquive');
const statVie = document.getElementById('statVie');
const pointsRestantsSpan = document.getElementById('pointsRestants');

const characterSheetPopup = document.getElementById('characterSheetPopup');
const pcText = document.getElementById('pcText');
const sheetAttaque = document.getElementById('sheetAttaque');
const sheetDefense = document.getElementById('sheetDefense');
const sheetEsquive = document.getElementById('sheetEsquive');
const sheetVie = document.getElementById('sheetVie');
const saveStatsBtn = document.getElementById('saveStatsBtn');
const cancelStatsBtn = document.getElementById('cancelStatsBtn');

function updateSheetPoints(){
    const remaining = parseInt(pcText.dataset.pc) || 0;

    pcText.textContent = `Points de CompÃ©tence restants : ${remaining}`;
    pcText.style.color = remaining === 0 ? "red" : "#3b2f2f"; // marron foncÃ©
}
// ========================
// FICHE PERSONNAGE (PC)
// ========================

function renderEffectiveStatsFromDatasets(){
  const classe = characterSheetPopup.dataset.classe || "";
  const base = classBaseStats[classe] || { attaque:0, defense:0, esquive:0, vie:0 };

  const a = parseInt(characterSheetPopup.dataset.allocAttaque || "0", 10);
  const d = parseInt(characterSheetPopup.dataset.allocDefense || "0", 10);
  const e = parseInt(characterSheetPopup.dataset.allocEsquive || "0", 10);
  const v = parseInt(characterSheetPopup.dataset.allocVie     || "0", 10);

  sheetAttaque.textContent = a + (base.attaque || 0);
  sheetDefense.textContent = d + (base.defense || 0);
  sheetEsquive.textContent = e + (base.esquive || 0);
  sheetVie.textContent     = v + (base.vie || 0);

  updateSheetPoints();
}

function openCharacterSheet(playerData){

  const stats = playerData.character.stats || {
    attaque:0, defense:0, esquive:0, vie:0, pointsRestants:10
  };

  const classe = playerData.character.classe;
  const base = classBaseStats[classe] || { attaque:0, defense:0, esquive:0, vie:0 };

  // PC
  const used = (stats.attaque||0)+(stats.defense||0)+(stats.esquive||0)+(stats.vie||0);
  const totalPc = used + (stats.pointsRestants||0);

  pcText.dataset.totalPc = totalPc;
  pcText.dataset.pc = stats.pointsRestants || 0;

  // stocke classe + points ATTRIBUÃ‰S (sans bonus)
  characterSheetPopup.dataset.classe = classe;
  characterSheetPopup.dataset.allocAttaque = stats.attaque || 0;
  characterSheetPopup.dataset.allocDefense = stats.defense || 0;
  characterSheetPopup.dataset.allocEsquive = stats.esquive || 0;
  characterSheetPopup.dataset.allocVie     = stats.vie || 0;

  document.getElementById('sheetClass').textContent =
    `Classe : ${classe} (Bonus â†’ ATK:${base.attaque} DEF:${base.defense} ESG:${base.esquive} VIE:${base.vie})`;

  document.getElementById('sheetTeam').textContent =
    `Ã‰quipe : ${playerData.character.team}`;

  document.getElementById('sheetLevel').textContent =
    `Niveau : ${playerData.level || 1}`;

  renderEffectiveStatsFromDatasets();

  overlay.style.display = 'block';
  characterSheetPopup.style.display = 'block';
}

// ========================
// Gestion + / - des stats
// ========================

function renderEffectiveStatsFromDatasets(){
  const classe = characterSheetPopup.dataset.classe || "";
  const base = classBaseStats[classe] || { attaque:0, defense:0, esquive:0, vie:0 };

  const a = parseInt(characterSheetPopup.dataset.allocAttaque || "0", 10);
  const d = parseInt(characterSheetPopup.dataset.allocDefense || "0", 10);
  const e = parseInt(characterSheetPopup.dataset.allocEsquive || "0", 10);
  const v = parseInt(characterSheetPopup.dataset.allocVie     || "0", 10);

  sheetAttaque.textContent = a + (base.attaque || 0);
  sheetDefense.textContent = d + (base.defense || 0);
  sheetEsquive.textContent = e + (base.esquive || 0);
  sheetVie.textContent     = v + (base.vie     || 0);

  updateSheetPoints();
}

document.querySelectorAll('.stat-row .inc').forEach(btn => {
  btn.onclick = () => {
    const stat = btn.dataset.stat;
    let remaining = parseInt(pcText.dataset.pc || "0", 10);
    if (remaining <= 0) return;

    const key =
      stat === "attaque" ? "allocAttaque" :
      stat === "defense" ? "allocDefense" :
      stat === "esquive" ? "allocEsquive" : "allocVie";

    let val = parseInt(characterSheetPopup.dataset[key] || "0", 10);
    characterSheetPopup.dataset[key] = val + 1;

    pcText.dataset.pc = remaining - 1;

    renderEffectiveStatsFromDatasets();
  };
});

document.querySelectorAll('.stat-row .dec').forEach(btn => {
  btn.onclick = () => {
    const stat = btn.dataset.stat;

    const key =
      stat === "attaque" ? "allocAttaque" :
      stat === "defense" ? "allocDefense" :
      stat === "esquive" ? "allocEsquive" : "allocVie";

    let val = parseInt(characterSheetPopup.dataset[key] || "0", 10);
    if (val <= 0) return; // ğŸ‘ˆ plancher = bonus de classe non retirable

    characterSheetPopup.dataset[key] = val - 1;

    let remaining = parseInt(pcText.dataset.pc || "0", 10);
    pcText.dataset.pc = remaining + 1;

    renderEffectiveStatsFromDatasets();
  };
});


document.querySelectorAll('.stat-row .dec').forEach(btn => {
  btn.onclick = () => {
    const stat = btn.dataset.stat;

    const key =
      stat === "attaque" ? "allocAttaque" :
      stat === "defense" ? "allocDefense" :
      stat === "esquive" ? "allocEsquive" :
      stat === "vie"     ? "allocVie" :
      null;

    if(!key) return;

    // on diminue le point ATTRIBUÃ‰ (pas le bonus)
    let val = parseInt(characterSheetPopup.dataset[key] || "0", 10);
    if (val <= 0) return; // impossible de descendre sous 0 attribuÃ©

    characterSheetPopup.dataset[key] = val - 1;

    // on rend 1 PC
    let remaining = parseInt(pcText.dataset.pc || "0", 10);
    pcText.dataset.pc = remaining + 1;

    // rafraÃ®chit l'affichage (attribuÃ© + bonus)
    renderEffectiveStatsFromDatasets();
  };
});








// ========================
// Cancel bouton
// ========================
cancelStatsBtn.onclick = () => {
    overlay.style.display='none';
    characterSheetPopup.style.display='none';
};

// ========================
// Save stats
// ========================
safeOnClick('saveStatsBtn', async () => {
  const attaque = parseInt(characterSheetPopup.dataset.allocAttaque || "0", 10);
  const defense = parseInt(characterSheetPopup.dataset.allocDefense || "0", 10);
  const esquive = parseInt(characterSheetPopup.dataset.allocEsquive || "0", 10);
  const vie     = parseInt(characterSheetPopup.dataset.allocVie     || "0", 10);

  const remaining = parseInt(pcText.dataset.pc || "0", 10);

  await db.collection('players').doc(currentUser).update({
    "character.stats.attaque": attaque,
    "character.stats.defense": defense,
    "character.stats.esquive": esquive,
    "character.stats.vie": vie,
    "character.stats.pointsRestants": remaining
  });

  alert("Stats mises Ã  jour !");
  overlay.style.display = 'none';
  characterSheetPopup.style.display = 'none';
});



const adminBtn = document.getElementById('adminBtn');
const adminPopup = document.getElementById('adminPopup');
const adminClose = document.getElementById('adminClose');
const adminPlayersList = document.getElementById('adminPlayersList');
const adminMonstersList = document.getElementById('adminMonstersList');

// ===== FONCTIONS POPUPS =====
function closeAllPopups(){
    overlay.style.display = 'none';
    createPopup.style.display = 'none';
    loginPopup.style.display = 'none';
    characterPopup.style.display = 'none';
    characterSheetPopup.style.display = 'none';
    adminPopup.style.display = 'none';

    // âœ… ajout : popup crÃ©ature
    const add = document.getElementById('addMonsterPopup');
    if(add) add.style.display = 'none';
}

function showPopup(id){
    overlay.style.display = 'block';
    document.getElementById(id).style.display = 'block';
}







sheetAttaque.oninput = sheetDefense.oninput = sheetEsquive.oninput = sheetVie.oninput = updateSheetPoints;

cancelStatsBtn.onclick = () => { overlay.style.display='none'; characterSheetPopup.style.display='none'; };







// ===== ADMIN =====
adminBtn.onclick = async () => {
    overlay.style.display = 'block';
    adminPopup.style.display = 'block';
    adminPlayersList.innerHTML = '';
setAdminTab("players");

    // CrÃ©ation du tableau
    const table = document.createElement('table');

    // EntÃªte
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr style="background-color:#d4af37;color:#000;">
            <th>Nom</th>
            <th>Classe</th>
            <th>Ã‰quipe</th>
            <th>Niveau</th>
            <th>XP</th>
            <th>Actions</th>
        </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    const snapshot = await db.collection('players').get();

    snapshot.forEach(docSnap => {
        const player = docSnap.data();
        const uid = docSnap.id;

        const tr = document.createElement('tr');

        if(player.character){
            // Nom
            const tdName = document.createElement('td');
            const nameInput = document.createElement('input');
            nameInput.value = player.character.name || '';
            nameInput.style.width = '90%';
            tdName.appendChild(nameInput);
            tr.appendChild(tdName);

            // Classe
            const tdClass = document.createElement('td');
            const classSelect = document.createElement('select');
            ['Guerrier','Voleur','Mage','NÃ©cromancien','Archer'].forEach(c=>{
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                classSelect.appendChild(opt);
            });
            classSelect.value = player.character.classe || '';
            tdClass.appendChild(classSelect);
            tr.appendChild(tdClass);

            // Ã‰quipe
            const tdTeam = document.createElement('td');
            const teamSelect = document.createElement('select');
            teamSelect.innerHTML = `
                <option value="Ordre du Dragon Pourpre âš”ï¸">Ordre du Dragon Pourpre âš”ï¸</option>
                <option value="ConfrÃ©rie du Serpent Noir ğŸ">ConfrÃ©rie du Serpent Noir ğŸ</option>
            `;
            teamSelect.value = player.character.team || "Ordre du Dragon Pourpre âš”ï¸";
            tdTeam.appendChild(teamSelect);
            tr.appendChild(tdTeam);

            // Niveau
            const tdLevel = document.createElement('td');
            tdLevel.textContent = player.level || 1;
            tr.appendChild(tdLevel);

            // XP
            const tdXP = document.createElement('td');
            tdXP.textContent = player.xp || 0;
            tr.appendChild(tdXP);

            // Actions
            const tdActions = document.createElement('td');

            // Enregistrer
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ğŸ’¾';
            saveBtn.onclick = async () => {
                await db.collection('players').doc(uid).update({
                    "character.name": nameInput.value,
                    "character.classe": classSelect.value,
                    "character.team": teamSelect.value
                });
                if(currentUser === uid) showVillageForCurrentUser(teamSelect.value);
                adminHandler(); // refresh
                alert('Modifications enregistrÃ©es !');
            };
            tdActions.appendChild(saveBtn);

            // Supprimer
            const delBtn = document.createElement('button');
            delBtn.textContent = 'ğŸ—‘ï¸';
            delBtn.onclick = async () => {
                if(confirm(`Supprimer ${player.character.name} ?`)){
                    await db.collection('players').doc(uid).update({ character: null });
                    adminHandler();
                    alert('Personnage supprimÃ©');
                }
            };
            tdActions.appendChild(delBtn);

            // Donner XP
            const xpBtn = document.createElement('button');
            xpBtn.textContent = 'âœ¨';
            xpBtn.onclick = async () => {
                const amount = parseInt(prompt("Combien d'XP donner ?"));
                if(!amount || amount <= 0) return;
                await giveXpToPlayer(uid, player, amount);
                alert(`${amount} XP accordÃ©e`);
                adminHandler();
            };
            tdActions.appendChild(xpBtn);

            tr.appendChild(tdActions);

        } else {
            const td = document.createElement('td');
            td.colSpan = 6;
            td.textContent = 'Pas de personnage';
            td.style.textAlign = 'center';
            tr.appendChild(td);
        }

        tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    adminPlayersList.appendChild(table);
await renderAdminMonsters();


    // ===== RÃ©parer le bouton fermer =====
    adminClose.onclick = () => {
        overlay.style.display = 'none';
        adminPopup.style.display = 'none';
    };
}
function setAdminTab(tab){
  const pBtn = document.getElementById('tabPlayersBtn');
  const mBtn = document.getElementById('tabMonstersBtn');
  const pPanel = document.getElementById('tabPlayersPanel');
  const mPanel = document.getElementById('tabMonstersPanel');

  if(!pBtn || !mBtn || !pPanel || !mPanel) return;

  const isPlayers = tab === "players";
  pPanel.style.display = isPlayers ? "block" : "none";
  mPanel.style.display = isPlayers ? "none" : "block";

  pBtn.classList.toggle("tab-active", isPlayers);
  mBtn.classList.toggle("tab-active", !isPlayers);

  // optionnel : ajuste classes
  pBtn.classList.toggle("btn-primary", isPlayers);
  mBtn.classList.toggle("btn-primary", !isPlayers);
}

safeOnClick('tabPlayersBtn', () => setAdminTab("players"));
safeOnClick('tabMonstersBtn', () => setAdminTab("monsters"));

adminClose.onclick = () => { overlay.style.display='none'; adminPopup.style.display='none'; };


// ===== FONCTION XP =====
async function giveXpToPlayer(uid,player,xpGained){
    if(!player.character){ alert("Pas de personnage !"); return; }
    if(!player.character.stats) player.character.stats={attaque:0,defense:0,esquive:0,vie:0,pointsRestants:0};
    let xp=player.xp||0;
    let level=player.level||1;
    let stats=player.character.stats;
    xp+=xpGained;
    let leveledUp=false;
    let nextLevelXp=10*level;
    while(xp>=nextLevelXp){
        xp-=nextLevelXp;
        level++;
        stats.pointsRestants+=1;
        leveledUp=true;
        nextLevelXp=10*level;
    }
    await db.collection('players').doc(uid).update({xp:xp,level:level,"character.stats":stats});
    if(leveledUp) alert(`ğŸ‰ ${player.character.name} monte niveau ${level} ! (+1 PC)`);
}

// ===== POPUPS BOUTONS =====
safeOnClick('createBtn', () => { overlay.style.display='block'; createPopup.style.display='block'; });
safeOnClick('loginBtn', () => { overlay.style.display='block'; loginPopup.style.display='block'; });
safeOnClick('createBack', closeAllPopups);
safeOnClick('loginBack', closeAllPopups);

overlay.onclick=closeAllPopups;

// ===== CREATION COMPTE =====
safeOnClick('createSubmit', async () => {
    const email = createEmail.value;
    const password = createPassword.value;
    if(email && password){
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email,password);
            await db.collection('players').doc(userCredential.user.uid).set({character:null});
            alert("Compte crÃ©Ã© !");
            closeAllPopups();
        } catch(e) {
            alert(e.message);
        }
    }
});

safeOnClick('loginSubmit', async () => {
    const email = loginEmail.value;
    const password = loginPassword.value;
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user.uid;
        const doc = await db.collection('players').doc(currentUser).get();
        if(!doc.exists) await db.collection('players').doc(currentUser).set({character:null,level:1,xp:0});
        closeAllPopups();
    } catch(e) {
        alert("Erreur : " + e.message);
    }
});


// ===== CONNEXION =====
document.getElementById('loginSubmit').onclick = async () => {
    const email = loginEmail.value;
    const password = loginPassword.value;
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user.uid;

        // CrÃ©e le joueur si inexistant
        const doc = await db.collection('players').doc(currentUser).get();
        if(!doc.exists) await db.collection('players').doc(currentUser).set({character:null,level:1,xp:0});

        closeAllPopups(); // ferme la popup login

        // Le reste (affichage village, fiche personnage, admin) est gÃ©rÃ© automatiquement par onAuthStateChanged
    } catch(e) {
        alert("Erreur : " + e.message);
    }
};


// ===== CREATION PERSONNAGE =====
safeOnClick('characterSubmit', async () => {
    const name = characterName.value;
    const classe = characterClass.value;

    const attaque = parseInt(statAttaque.value) || 0;
    const defense = parseInt(statDefense.value) || 0;
    const esquive = parseInt(statEsquive.value) || 0;
    const vie = parseInt(statVie.value) || 0;

    const totalUsed = attaque + defense + esquive + vie;
    if(totalUsed > creationPointsRestants){
        alert("Vous avez dÃ©passÃ© vos 10 points !");
        return;
    }

    const team = teamToggle === 0
        ? 'Lâ€™Ordre du Dragon Pourpre âš”ï¸'
        : 'La ConfrÃ©rie du Serpent Noir ğŸ';
    teamToggle = teamToggle === 0 ? 1 : 0;

    const finalStats = { attaque, defense, esquive, vie, pointsRestants: creationPointsRestants - totalUsed };

    await db.collection('players').doc(currentUser).set({
        character: { name, classe, team, stats: finalStats, gold:0, houseLevel:0 },
        level:1, xp:0
    });

    closeAllPopups();

    welcomeText.textContent = `Bienvenue ${name}, ${classe}.`;
    teamText.textContent = `Ã‰quipe : ${team}`;
});




// ===== DECONNEXION =====
safeOnClick('logoutBtn', async () => {
    await auth.signOut();
    currentUser = null;
    villagePage.style.display = 'none';
    loginPage.style.display = 'block';
    adminBtn.style.display = 'none';
    teamText.textContent = '';
});

function getStatTotal(statName, playerStats, classBase) {
    return (playerStats[statName] || 0) + (classBase[statName] || 0);
}


// ===== OUVRIR FICHE PERSONNAGE =====
safeOnClick('openCharacterSheetBtn', async () => {
    const playerDoc = await db.collection('players').doc(currentUser).get();
    const data = playerDoc.data();
    if(!data.character){
        alert("Aucun personnage crÃ©Ã©.");
        return;
    }
    openCharacterSheet(data);
});



// Liste des ennemis PVE
const enemies = [
  { name: "Lapin", hp: 3, attack: 1, defense: 0, gold: 1 },
  { name: "Rat", hp: 4, attack: 2, defense: 1, gold: 2 },
  { name: "Corbeau", hp: 5, attack: 3, defense: 0, gold: 3 },
  { name: "Gobelin", hp: 8, attack: 4, defense: 2, gold: 5 },
  { name: "Kobold", hp: 10, attack: 5, defense: 3, gold: 6 },
  { name: "Loup", hp: 12, attack: 6, defense: 4, gold: 8 },
  { name: "AraignÃ©e gÃ©ante", hp: 14, attack: 5, defense: 5, gold: 10 },
  { name: "Orc", hp: 18, attack: 8, defense: 6, gold: 12 },
  { name: "Troll", hp: 25, attack: 10, defense: 8, gold: 18 },
  { name: "Squelette", hp: 15, attack: 7, defense: 5, gold: 10 },
  { name: "Zombie", hp: 20, attack: 6, defense: 7, gold: 12 },
  { name: "Ogre", hp: 30, attack: 12, defense: 10, gold: 20 },
  { name: "SorciÃ¨re", hp: 18, attack: 14, defense: 5, gold: 25 },
  { name: "Worg", hp: 22, attack: 11, defense: 7, gold: 18 },
  { name: "Minotaure", hp: 35, attack: 15, defense: 12, gold: 30 },
  { name: "Liche", hp: 28, attack: 18, defense: 8, gold: 40 },
  { name: "Gargouille", hp: 32, attack: 12, defense: 15, gold: 35 },
  { name: "Dragonnet", hp: 40, attack: 20, defense: 12, gold: 50 },
  { name: "Wyverne", hp: 45, attack: 22, defense: 15, gold: 55 },
  { name: "Hydre", hp: 50, attack: 18, defense: 20, gold: 60 },
  { name: "Vampire", hp: 38, attack: 25, defense: 10, gold: 70 },
  { name: "DÃ©mon mineur", hp: 42, attack: 23, defense: 15, gold: 65 },
  { name: "Elementaire de feu", hp: 48, attack: 22, defense: 18, gold: 80 },
  { name: "Elementaire dâ€™eau", hp: 50, attack: 18, defense: 20, gold: 75 },
  { name: "Elementaire de terre", hp: 55, attack: 20, defense: 22, gold: 90 },
  { name: "Elementaire dâ€™air", hp: 45, attack: 25, defense: 15, gold: 85 },
  { name: "Dragon", hp: 60, attack: 28, defense: 20, gold: 100 },
  { name: "ChimÃ¨re", hp: 55, attack: 30, defense: 18, gold: 95 },
  { name: "Succube", hp: 40, attack: 32, defense: 12, gold: 80 },
  { name: "Harpie", hp: 38, attack: 28, defense: 10, gold: 70 },
  { name: "Griffon", hp: 50, attack: 32, defense: 20, gold: 90 },
  { name: "Kraken", hp: 80, attack: 35, defense: 25, gold: 150 },
  { name: "Manticore", hp: 60, attack: 38, defense: 22, gold: 120 },
  { name: "Sphinx", hp: 55, attack: 30, defense: 28, gold: 110 },
  { name: "DÃ©mon majeur", hp: 65, attack: 40, defense: 25, gold: 130 },
  { name: "Dragon adulte", hp: 70, attack: 45, defense: 35, gold: 150 },
  { name: "Titan", hp: 85, attack: 50, defense: 40, gold: 200 },
  { name: "Ancien Troll", hp: 75, attack: 48, defense: 38, gold: 180 },
  { name: "Dragon noir", hp: 90, attack: 55, defense: 45, gold: 220 },
  { name: "Dragon rouge", hp: 95, attack: 60, defense: 50, gold: 250 },
  { name: "Balrog", hp: 100, attack: 70, defense: 60, gold: 300 },
];
const classBaseStats = {
    "Guerrier": { attaque: 3, defense: 2, esquive: 0, vie: 2 },
    "Voleur": { attaque: 1, defense: 1, esquive: 3, vie: 2 },
    "Mage": { attaque: 4, defense: 0, esquive: 1, vie: 1 },
    "NÃ©cromancien": { attaque: 2, defense: 1, esquive: 1, vie: 3 },
    "Archer": { attaque: 2, defense: 1, esquive: 2, vie: 2 }
};

async function explore() {

    if(!currentUser){
        alert("Connecte-toi d'abord !");
        return;
    }

    const doc = await db.collection('players').doc(currentUser).get();
    const data = doc.data();
// ===== Limite combats / jour =====
const limit = gameConfig.dailyCombatLimit || 0;

if(limit > 0){
  const today = getTodayKeyParis();
  const dc = data.character.dailyCombats || { date: today, count: 0 };
  const countToday = (dc.date === today) ? (dc.count || 0) : 0;

  if(countToday >= limit){
    alert(`Limite atteinte : ${limit} combats aujourdâ€™hui.`);
    return;
  }

  await db.collection('players').doc(currentUser).update({
    "character.dailyCombats": { date: today, count: countToday + 1 }
  });

  data.character.dailyCombats = { date: today, count: countToday + 1 };
}

    if(!data.character){
        alert("Aucun personnage !");
        return;
    }

    const stats = data.character.stats;

    const classe = data.character.classe;
const base = classBaseStats[classe] || {attaque:0, defense:0, esquive:0, vie:0};

const playerStats = {
    hp: (stats.vie || 0) + base.vie,
    attack: (stats.attaque || 0) + base.attaque,
    defense: (stats.defense || 0) + base.defense,
    dodge: (stats.esquive || 0) + base.esquive   // <- si tu utilises esquive
};



    const snapshot = await db.collection('monsters').get();

const monsters = [];
snapshot.forEach(doc => monsters.push(doc.data()));

if(monsters.length === 0){
    alert("Aucune crÃ©ature disponible !");
    return;
}

const idx = Math.floor(Math.random() * monsters.length);
const monster = monsters[idx];

// Enregistrement du monstre rencontrÃ© pour le bestiaire
let encountered = data.encountered || [];

if (!encountered.includes(monster.name)) {
    encountered.push(monster.name);

    await db.collection('players').doc(currentUser).update({
        encountered: encountered
    });
}

    const playerPower = playerStats.hp + playerStats.attack + playerStats.defense;
    const monsterPower = monster.hp + monster.attack + monster.defense;

    const contentDiv = document.getElementById('exploreContent');

let monsterEmoji = 'ğŸ‘¾';
if(monster.name.toLowerCase().includes('lapin')) monsterEmoji='ğŸ‡';
else if(monster.name.toLowerCase().includes('rat')) monsterEmoji='ğŸ€';
else if(monster.name.toLowerCase().includes('dragon')) monsterEmoji='ğŸ‰';
else if(monster.name.toLowerCase().includes('balrog')) monsterEmoji='ğŸ”¥';

const pHP = playerStats.hp;
const pATK = playerStats.attack;
const pDEF = playerStats.defense;

const mHP = monster.hp ?? 0;
const mATK = monster.attack ?? 0;
const mDEF = monster.defense ?? 0;

// log + rÃ©compense
let logText = "";
let isWin = (playerPower >= monsterPower);

if(isWin){
  logText = `ğŸ‰ <b>Victoire !</b> Tu rÃ©cupÃ¨res <b>${monster.gold ?? 0} sous</b>.`;
} else {
  logText = `ğŸ’€ <b>DÃ©faite...</b> Tu bats en retraite sans butin.`;
}
// ===== GAIN D'OR =====
let currentGold = data.character.gold || 0;
const gainedGold = isWin ? (monster.gold || 0) : 0;
const newGold = currentGold + gainedGold;

// Gestion du bestiaire
let metMonsters = data.character.metMonsters || [];
if(!metMonsters.includes(monster.name)){
    metMonsters.push(monster.name);
}

// ğŸ”¥ UPDATE FIRESTORE
await db.collection('players').doc(currentUser).update({
    "character.gold": newGold,
    "character.metMonsters": metMonsters
});

// âœ… UPDATE BANQUE IMMÃ‰DIAT
updateBankDisplay({
    character: {
        gold: newGold
    }
});

contentDiv.innerHTML = `
  <div class="combat-wrap combat-animate">
    <div class="combat-top">
      <div class="combat-card">
        <div class="combat-name">${data.character.name}</div>
        <div class="combat-stats">
          <span class="badge">â¤ï¸ HP: ${pHP}</span>
          <span class="badge">âš”ï¸ ATK: ${pATK}</span>
          <span class="badge">ğŸ›¡ï¸ DEF: ${pDEF}</span>
        </div>
        <div class="hpbar"><div class="hpfill" style="width:100%"></div></div>
      </div>

      <div class="combat-vs">VS</div>

      <div class="combat-card" id="monsterCard">
        <div class="combat-name">${monster.name}</div>
        <div class="combat-emoji">${monsterEmoji}</div>
        <div class="combat-stats">
          <span class="badge">â¤ï¸ HP: ${mHP}</span>
          <span class="badge">âš”ï¸ ATK: ${mATK}</span>
          <span class="badge">ğŸ›¡ï¸ DEF: ${mDEF}</span>
          <span class="badge">ğŸ’° Or: ${monster.gold ?? 0}</span>
        </div>
        <div class="hpbar"><div class="hpfill" style="width:100%"></div></div>
      </div>
    </div>

    <div class="combat-log">${logText}</div>
  </div>
`;

showPopup('explorePopup');

// petit feedback visuel
const monsterCard = document.getElementById("monsterCard");
if(monsterCard && isWin){
  // le monstre "prend un coup"
  monsterCard.classList.add("shake");
  setTimeout(() => monsterCard.classList.remove("shake"), 260);
}
}


// Boutons de la popup
document.getElementById('exploreClose').onclick = () => {
    overlay.style.display = 'none';
    document.getElementById('explorePopup').style.display = 'none';
};

document.getElementById('exploreNext').onclick = () => {
    explore(); // relance un nouveau combat
};

// Bouton explorer dans le village
document.getElementById('exploreBtn').onclick = () => {
    explore();
};

// Charger les donnÃ©es depuis Firestore si joueur connectÃ©

function upgradeHouse(cost) {
    if (bank.gold >= cost) {
        bank.gold -= cost;
        bank.houseSpent += cost;
        updateBankDisplay();

        // Mise Ã  jour Firestore
        db.collection('players').doc(currentUser).update({
            "character.gold": bank.gold,
            "character.spentHouse": bank.houseSpent

        });
    } else {
        alert("Pas assez de sous !");
    }
}

function upgradeVillage(cost) {
    if (bank.gold >= cost) {
        bank.gold -= cost;
        bank.villageSpent += cost;
        updateBankDisplay();

        db.collection('players').doc(currentUser).update({
            "character.gold": bank.gold,
            "character.spentVillage": bank.villageSpent

        });
    } else {
        alert("Pas assez de sous !");
    }
}
safeOnClick('exploreBtn', explore);

// ===== AJOUT CRÃ‰ATURE =====
safeOnClick('saveMonsterBtn', async () => {


    const name = document.getElementById('monsterName').value;
    const attack = parseInt(document.getElementById('monsterAttack').value);
    const defense = parseInt(document.getElementById('monsterDefense').value);
    const hp = parseInt(document.getElementById('monsterHp').value);
    const gold = parseInt(document.getElementById('monsterGold').value);

    const imageFile = document.getElementById('monsterImage').files[0];

    if(!name || !attack || !defense || !hp || !gold){
        alert("Merci de remplir tous les champs !");
        return;
    }

    let imageUrl = "";

    if(imageFile){
        const storageRef = firebase.storage().ref();
        const imgRef = storageRef.child("monsters/" + name + ".png");

        await imgRef.put(imageFile);

        imageUrl = await imgRef.getDownloadURL();
    }
if (imageFile && !imageUrl) {
  alert("L'upload de l'image a Ã©chouÃ© : la crÃ©ature ne sera pas enregistrÃ©e.");
  return;
}

    await db.collection("monsters").add({
        name,
        attack,
        defense,
        hp,
        gold,
        image: imageUrl
    });

    alert("CrÃ©ature ajoutÃ©e au bestiaire !");

    closeAllPopups();
});

async function renderAdminMonsters() {
    if (!adminMonstersList) return;

    adminMonstersList.innerHTML = "";

    const table = document.createElement("table");

    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr style="background-color:#d4af37;color:#000;">
        <th>Nom</th>
        <th>ATK</th>
        <th>DEF</th>
        <th>HP</th>
        <th>Or</th>
        <th>Actions</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    const snap = await db.collection("monsters").get();

    snap.forEach(docSnap => {
        const m = docSnap.data();
        const id = docSnap.id;

        const tr = document.createElement("tr");

        const nameInput = document.createElement("input");
        nameInput.value = m.name || "";
        nameInput.style.width = "95%";

        const atkInput = document.createElement("input");
        atkInput.type = "number";
        atkInput.value = m.attack ?? 0;
        atkInput.style.width = "70px";

        const defInput = document.createElement("input");
        defInput.type = "number";
        defInput.value = m.defense ?? 0;
        defInput.style.width = "70px";

        const hpInput = document.createElement("input");
        hpInput.type = "number";
        hpInput.value = m.hp ?? 0;
        hpInput.style.width = "70px";

        const goldInput = document.createElement("input");
        goldInput.type = "number";
        goldInput.value = m.gold ?? 0;
        goldInput.style.width = "70px";

        const tdName = document.createElement("td"); tdName.appendChild(nameInput);
        const tdAtk = document.createElement("td"); tdAtk.appendChild(atkInput);
        const tdDef = document.createElement("td"); tdDef.appendChild(defInput);
        const tdHp  = document.createElement("td"); tdHp.appendChild(hpInput);
        const tdGold= document.createElement("td"); tdGold.appendChild(goldInput);

        const tdActions = document.createElement("td");

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "ğŸ’¾";
        saveBtn.title = "Enregistrer";
        saveBtn.onclick = async () => {
            await db.collection("monsters").doc(id).update({
                name: nameInput.value.trim(),
                attack: parseInt(atkInput.value, 10) || 0,
                defense: parseInt(defInput.value, 10) || 0,
                hp: parseInt(hpInput.value, 10) || 0,
                gold: parseInt(goldInput.value, 10) || 0
            });
            alert("CrÃ©ature mise Ã  jour !");
        };

        const delBtn = document.createElement("button");
        delBtn.textContent = "ğŸ—‘ï¸";
        delBtn.title = "Supprimer";
        delBtn.onclick = async () => {
            if (!confirm(`Supprimer "${m.name || "cette crÃ©ature"}" ?`)) return;
            await db.collection("monsters").doc(id).delete();
            await renderAdminMonsters(); // refresh
            alert("CrÃ©ature supprimÃ©e.");
        };

        tdActions.appendChild(saveBtn);
        tdActions.appendChild(delBtn);

        tr.appendChild(tdName);
        tr.appendChild(tdAtk);
        tr.appendChild(tdDef);
        tr.appendChild(tdHp);
        tr.appendChild(tdGold);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    adminMonstersList.appendChild(table);
}


// ===== BESTIAIRE =====

// Associe un emoji Ã  chaque monstre selon son nom
function getMonsterEmoji(name) {
    name = name.toLowerCase();
    if (name.includes('lapin')) return 'ğŸ‡';
    if (name.includes('rat')) return 'ğŸ€';
    if (name.includes('dragon')) return 'ğŸ‰';
    if (name.includes('balrog')) return 'ğŸ”¥';
    if (name.includes('loup')) return 'ğŸº';
    if (name.includes('araignÃ©e')) return 'ğŸ•·ï¸';
    if (name.includes('orque')) return 'ğŸ§Œ';
    if (name.includes('squelette')) return 'ğŸ’€';
    if (name.includes('vampire')) return 'ğŸ§›';
    if (name.includes('hydre')) return 'ğŸ';
    return 'ğŸ‘¾';
}

async function openBestiary() {
    if (!currentUser) return;

    const doc = await db.collection('players').doc(currentUser).get();
    const data = doc.data();

    // Monstres rÃ©ellement "dÃ©couverts" (selon ton systÃ¨me actuel)
    const met = (data.character && data.character.metMonsters) ? data.character.metMonsters : [];

    const content = document.getElementById('bestiaryContent');
    content.innerHTML = ""; // reset

    // 1) Charger les monstres depuis Firestore
    const snapshot = await db.collection('monsters').get();
const monsters = [];
snapshot.forEach(d => monsters.push({ id: d.id, ...d.data() }));


    // 2) Calculer total APRES initialisation
    const total = monsters.length;

// On sÃ©curise et on enlÃ¨ve les doublons
const metSet = new Set((met || []).filter(Boolean));

// Compte uniquement les monstres existants dans la collection
const count = monsters.filter(m => metSet.has(m.name)).length;


    // Titre
    content.innerHTML = `<h2>ğŸ“– Bestiaire â€“ ${count} / ${total}</h2>`;

// 3) Affichage
monsters.forEach(monster => {
    const line = document.createElement('p');

    const emoji = getMonsterEmoji(monster.name || "");
    const seen = metSet.has(monster.name);

    if (seen) {
        line.innerHTML = `${emoji} <b>${monster.name}</b> â€“ RÃ©compense : ${monster.gold ?? 0} sous`;
        line.style.cursor = "pointer";
        line.onclick = () => showMonsterDetails(monster);
    } else {
        line.innerHTML = `${emoji} <b>???</b> â€“ Monstre inconnu`;
        line.style.opacity = "0.4";
        line.style.cursor = "default";
        line.onclick = null;
    }

    content.appendChild(line);
});


    overlay.style.display = 'block';
    document.getElementById('bestiaryPopup').style.display = 'block';
}
function showMonsterDetails(monster) {

    const content = document.getElementById('bestiaryContent');

    content.innerHTML = `
        <h2>${monster.name}</h2>
        ${monster.image ? `<img src="${monster.image}" style="width:180px; display:block; margin:10px auto; border-radius:12px; border:2px solid #d4af37;">` : ""}
        <p>â¤ï¸ Vie : ${monster.hp}</p>
        <p>âš”ï¸ Attaque : ${monster.attack}</p>
        <p>ğŸ›¡ï¸ DÃ©fense : ${monster.defense}</p>
        <p>ğŸ’° RÃ©compense : ${monster.gold ?? 0} sous</p>
        <button onclick="openBestiary()">â¬… Retour au bestiaire</button>
    `;
}

// =======================
// AJOUT CRÃ‰ATURE (ADMIN)
// =======================

function openAddMonsterPopup(){
    overlay.style.display = 'block';
    document.getElementById('addMonsterPopup').style.display = 'block';
}

function closeAddMonsterPopup(){
    document.getElementById('addMonsterPopup').style.display = 'none';
    overlay.style.display = 'none';

    // reset champs
    document.getElementById('addMonsterName').value = '';
    document.getElementById('addMonsterAttack').value = '';
    document.getElementById('addMonsterDefense').value = '';
    document.getElementById('addMonsterHp').value = '';
    document.getElementById('addMonsterGold').value = '';
    document.getElementById('addMonsterImage').value = '';
}

// Ouvrir popup depuis Admin
safeOnClick('openAddMonsterBtn', () => {
    // (optionnel) fermer lâ€™admin pour Ã©viter 2 popups empilÃ©es
    document.getElementById('adminPopup').style.display = 'none';
    openAddMonsterPopup();
});

// Bouton annuler
safeOnClick('addMonsterCancelBtn', () => {
    closeAddMonsterPopup();
});

// Enregistrer crÃ©ature (sans image pour lâ€™instant si tu nâ€™as pas encore Storage OK)
safeOnClick('addMonsterSaveBtn', async () => {

    const name = document.getElementById('addMonsterName').value.trim();
    const attack = parseInt(document.getElementById('addMonsterAttack').value, 10);
    const defense = parseInt(document.getElementById('addMonsterDefense').value, 10);
    const hp = parseInt(document.getElementById('addMonsterHp').value, 10);
    const gold = parseInt(document.getElementById('addMonsterGold').value, 10);

    const imageFile = document.getElementById('addMonsterImage').files[0];

    // IMPORTANT : autoriser 0 (par ex dÃ©fense 0) => on teste isNaN, pas "!attack"
    if(!name || Number.isNaN(attack) || Number.isNaN(defense) || Number.isNaN(hp) || Number.isNaN(gold)){
        alert("Merci de remplir tous les champs (les nombres peuvent Ãªtre Ã  0).");
        return;
    }

    // Image : si tu nâ€™as pas encore Firebase Storage configurÃ© correctement, laisse vide
    let imageUrl = "";

    // âœ… Si tu veux activer lâ€™upload image, il faut (1) inclure firebase-storage-compat.js et (2) rÃ¨gles Storage.
    // Pour Ã©viter de casser ton app maintenant, on ne tente lâ€™upload que si firebase.storage existe.
    console.log("firebase.storage =", firebase.storage);
console.log("imageFile =", imageFile);

    if (imageFile && typeof firebase.storage === "function") {
        try{
            const storageRef = firebase.storage().ref();
            const safeName = name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
            const imgRef = storageRef.child("monsters/" + safeName + "-" + Date.now() + ".png");
            await imgRef.put(imageFile);
            imageUrl = await imgRef.getDownloadURL();
        }catch(e){
            console.error(e);
            alert("Image non enregistrÃ©e (Storage non configurÃ©). La crÃ©ature sera ajoutÃ©e sans image.");
            imageUrl = "";
        }
    }
console.log("IMAGE URL =", imageUrl);
alert(imageUrl);

    await db.collection("monsters").add({
        name,
        attack,
        defense,
        hp,
        gold,
        image: imageUrl
    });

    alert("CrÃ©ature ajoutÃ©e !");
    closeAddMonsterPopup();
    if (document.getElementById('monstersAdminPopup').style.display === 'block') {
  loadMonstersList();
}

});
// =======================
// PAGE ADMIN - CREATURES
// =======================
let monstersCache = [];

function openMonstersAdminPopup(){
  const u = firebase.auth().currentUser;
  if(!u || u.email !== adminEmail){
    alert("AccÃ¨s admin refusÃ©.");
    return;
  }

  overlay.style.display = 'block';

  // on cache le panel admin et on affiche la page crÃ©atures
  document.getElementById('adminPopup').style.display = 'none';
  document.getElementById('monstersAdminPopup').style.display = 'block';

  loadMonstersList();
}

function backToAdminPopup(){
  document.getElementById('monstersAdminPopup').style.display = 'none';
  document.getElementById('adminPopup').style.display = 'block';
}

// charge les monstres depuis Firestore
async function loadMonstersList(){
  const list = document.getElementById('monstersList');
  if(!list){
    console.error("âŒ monstersList introuvable (id manquant dans le HTML)");
    return;
  }

  list.innerHTML = "<p>Chargement...</p>";

  try{
    const snap = await db.collection("monsters").get();
    monstersCache = [];
    snap.forEach(d => monstersCache.push({ id: d.id, ...d.data() }));

    console.log("âœ… monstersCache size =", monstersCache.length);
    renderMonstersList();
  } catch(e){
    console.error("âŒ loadMonstersList error =", e);
    list.innerHTML = "<p>Erreur de chargement (voir console F12).</p>";
  }
}

// affiche la liste (filtre par recherche)
function renderMonstersList(){
  const list = document.getElementById('monstersList');
  const searchEl = document.getElementById('monsterSearchInput');
  if(!list) return;

  const q = (searchEl?.value || "").toLowerCase().trim();

  let rows = monstersCache.slice();
  if(q) rows = rows.filter(m => (m.name || "").toLowerCase().includes(q));

  list.innerHTML = "";

  if(rows.length === 0){
    list.innerHTML = "<p>Aucune crÃ©ature.</p>";
    return;
  }

  rows.forEach(m => {
    const line = document.createElement("div");
    line.style.display = "flex";
    line.style.justifyContent = "space-between";
    line.style.alignItems = "center";
    line.style.padding = "8px";
    line.style.borderBottom = "1px solid #ddd";
    line.style.gap = "10px";

    const left = document.createElement("div");
    left.style.flex = "1";
    left.style.cursor = "pointer";
    left.innerHTML = `<b>${m.name || "(sans nom)"}</b> <span style="opacity:.8;">â€” ATK:${m.attack ?? 0} DEF:${m.defense ?? 0} HP:${m.hp ?? 0} Or:${m.gold ?? 0}</span>`;

    // clic = ouvre ta popup d'Ã©dition (doit exister)
    left.onclick = () => openEditMonster(m);

    const right = document.createElement("div");

    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸";
    editBtn.title = "Modifier";
    editBtn.onclick = () => openEditMonster(m);

    const delBtn = document.createElement("button");
    delBtn.textContent = "ğŸ—‘ï¸";
    delBtn.title = "Supprimer";
    delBtn.onclick = async () => {
      if(!confirm(`Supprimer "${m.name}" ?`)) return;
      await db.collection("monsters").doc(m.id).delete();
      monstersCache = monstersCache.filter(x => x.id !== m.id);
      renderMonstersList();
    };

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    line.appendChild(left);
    line.appendChild(right);

    list.appendChild(line);
  });
}

// -----------------------
// Branchement des boutons
// -----------------------
safeOnClick('openMonstersAdminBtn', openMonstersAdminPopup);
safeOnClick('monstersBackToAdminBtn', backToAdminPopup);
safeOnClick('monstersCreateBtn', () => { backToAdminPopup(); openAddMonsterPopup(); });

const searchInput = document.getElementById('monsterSearchInput');
if(searchInput) searchInput.oninput = renderMonstersList;

function toast(msg, type="info", ms=2200){
  const host = document.getElementById("toastHost");
  if(!host){ alert(msg); return; }

  const el = document.createElement("div");
  el.className = `toast ${type}`;

  const icon = type === "success" ? "âœ…" : type === "error" ? "â›”" : "â„¹ï¸";

  el.innerHTML = `<div class="ticon">${icon}</div><div class="tmsg">${msg}</div>`;
  host.appendChild(el);

  setTimeout(() => {
    el.style.opacity = "0";
    el.style.transform = "translateY(6px)";
    el.style.transition = "all .18s ease";
    setTimeout(() => el.remove(), 220);
  }, ms);
}

// =======================
// CONFIG JEU - COMBATS / JOUR
// =======================
let gameConfig = { dailyCombatLimit: 0 };

function getTodayKeyParis(){
  return new Intl.DateTimeFormat('fr-CA', { timeZone: 'Europe/Paris' }).format(new Date());
}

async function loadGameConfig(){
  try{
    const doc = await db.collection("config").doc("game").get();
    const data = doc.exists ? doc.data() : {};
    gameConfig.dailyCombatLimit = parseInt(data.dailyCombatLimit, 10) || 0;

    const input = document.getElementById("dailyCombatLimitInput");
    const info = document.getElementById("dailyCombatLimitInfo");

    if(input) input.value = gameConfig.dailyCombatLimit;
    if(info){
      info.textContent = gameConfig.dailyCombatLimit > 0
        ? `Limite actuelle : ${gameConfig.dailyCombatLimit} combats / jour`
        : `Limite actuelle : illimitÃ©`;
    }
  }catch(e){
    console.error("loadGameConfig error =", e);
  }
}

async function saveGameConfigDailyLimit(){
  const u = firebase.auth().currentUser;
  if(!u || u.email !== adminEmail){
    alert("AccÃ¨s admin refusÃ©.");
    return;
  }

  const raw = document.getElementById("dailyCombatLimitInput").value;
  const limit = Math.max(0, parseInt(raw, 10) || 0);

  await db.collection("config").doc("game").set({ dailyCombatLimit: limit }, { merge: true });
  gameConfig.dailyCombatLimit = limit;

  const info = document.getElementById("dailyCombatLimitInfo");
  if(info){
    info.textContent = limit > 0 ? `Limite actuelle : ${limit} combats / jour` : `Limite actuelle : illimitÃ©`;
  }

  if (typeof toast === "function") toast("Limite enregistrÃ©e.", "success");
  else alert("Limite enregistrÃ©e.");
}

// =======================
// BRANCHEMENTS PARAMETRES
// =======================

// bouton sauvegarde
safeOnClick('saveDailyCombatLimitBtn', saveGameConfigDailyLimit);

// clic sur lâ€™onglet ParamÃ¨tres
safeOnClick('tabSettingsBtn', async () => {
  setAdminTab("settings");
  await loadGameConfig();
});
// DEBUG + OUVERTURE ONGLET PARAMETRES (bÃ©ton)
safeOnClick('tabSettingsBtn', async () => {
  console.log("âœ… click tabSettingsBtn");
  const p = document.getElementById('tabPlayersPanel');
  const m = document.getElementById('tabMonstersPanel');
  const s = document.getElementById('tabSettingsPanel');

  console.log("panels:", !!p, !!m, !!s);

  if(p) p.style.display = "none";
  if(m) m.style.display = "none";
  if(s) s.style.display = "block";

  await loadGameConfig();
});
function getTodayKeyParis(){
  return new Intl.DateTimeFormat('fr-CA', { timeZone: 'Europe/Paris' }).format(new Date());
}

async function ensureDailyCombatCounter() {
  if(!currentUser) return;

  const today = getTodayKeyParis();
  const ref = db.collection('players').doc(currentUser);
  const snap = await ref.get();
  const data = snap.data();
  if(!data || !data.character) return;

  const dc = data.character.dailyCombats;

  // si absent -> on crÃ©e
  if(!dc || typeof dc !== "object" || !dc.date){
    await ref.update({
      "character.dailyCombats": { date: today, count: 0 }
    });
    return;
  }

  // si jour diffÃ©rent -> reset
  if(dc.date !== today){
    await ref.update({
      "character.dailyCombats": { date: today, count: 0 }
    });
  }
}



</script>
<div id="toastHost" style="position:fixed; right:14px; bottom:14px; display:flex; flex-direction:column; gap:10px; z-index:9999;"></div>

</body>
</html>
